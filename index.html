<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Ryan WP Stats</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#155e2e" />
  <style>
    :root{--green:#155e2e;--gold:#d4af37;--bg:#f7f7f9;--card:#fff;--line:#e9e9ef}
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;background:var(--bg)}
    header{position:sticky;top:0;z-index:5;background:var(--green);color:#fff;border-bottom:3px solid var(--gold)}
    .header-inner{display:flex;justify-content:space-between;align-items:center;padding:10px 12px}
    h1{margin:0;font-size:18px}
    .status-pill{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.15);font-size:12px}
    .menu-btn{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.25);padding:8px 10px;border-radius:10px}
    .menu-panel{position:absolute;right:8px;top:54px;background:#fff;color:#111;border:1px solid #ddd;border-radius:12px;padding:8px;display:none;min-width:260px;box-shadow:0 10px 30px rgba(0,0,0,.12)}
    .menu-panel button{width:100%;text-align:left;padding:10px;border:none;background:#fff;border-radius:8px}
    .menu-panel button:hover{background:#f5f5f7}
    .tabs{display:flex;position:sticky;top:52px;background:#fff;border-bottom:1px solid var(--line);z-index:4}
    .tab{flex:1;padding:12px;border:none;background:#fff;border-bottom:3px solid transparent}
    .tab.active{border-bottom-color:var(--gold);font-weight:600}
    main{padding:12px}
    .panel{display:none}.panel.active{display:block}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .meta{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    .meta input,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd}
    .controls{display:grid;grid-template-columns:1fr 86px 82px 86px;gap:8px;align-items:center}
    .controls .label{font-weight:600}
    .counter{text-align:center;padding:12px;border:1px solid #ddd;border-radius:10px;background:#fff;font-size:18px}
    .row{padding:6px 0;border-bottom:1px solid #f1f1f4}.row:last-child{border-bottom:none}
    .grid2{display:grid;grid-template-columns:1fr;gap:10px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button{border:1px solid #ddd;background:#fff;padding:12px;border-radius:12px;font-size:16px}
    .btn-sm{padding:8px 10px;font-size:14px;border-radius:10px}
    .primary{background:#155e2e;color:#fff;border:none}
    .danger{background:#e33;color:#fff;border:none}
    .timer{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    .timer .time{font-weight:700;font-variant-numeric:tabular-nums;padding:8px 12px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    #ptToggle.running{background:var(--gold);color:#111;border:none}
    .fine{font-size:12px;color:#666}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px 4px;text-align:left}
    td.right{text-align:right}

    /* Trends canvas responsive */
    #trendCanvas { width:100%; height:240px; display:block; }

    /* ---------- Print layout ---------- */
    @media print {
      @page { size: letter portrait; margin: 0.5in; }
      body { background: #fff !important; }
      header, .tabs, .menu-panel, .menu-btn, .status-pill { display: none !important; }
      header, .tabs { position: static !important; }
      main { padding: 0 !important; }
      .card { border: none !important; box-shadow: none !important; border-radius: 0 !important; padding: 0 !important; }
      button, .actions, .row button, .timer button { display: none !important; }
      .controls { grid-template-columns: 1fr 120px !important; gap: 8px !important; padding: 6px 0 !important; }
      .controls .label { font-weight: 600; }
      .counter { border: none !important; background: transparent !important; text-align: right !important; padding: 0 !important; }
      .row { border-bottom: 1px solid #ddd !important; }
      .meta { grid-template-columns: 1fr 1fr !important; gap: 12px !important; margin: 0 0 12px 0 !important; }
      .meta input { border: none !important; padding: 0 !important; font-size: 14px !important; }
      .timer { margin: 0 0 8px 0 !important; }
      .timer .time { border: none !important; padding: 0 !important; font-weight: 600 !important; }
      textarea#notes { border: none !important; padding: 0 !important; min-height: unset !important; height: auto !important; resize: none !important; }
      table { width: 100% !important; }
      th, td { padding: 4px 0 !important; }
    }
  /* Keep Print button inline with other controls on small screens */
.actions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.actions button {
  flex: 1;
  max-width: 150px; /* adjust as needed */
}
@media (max-width: 480px) {
  .actions button {
    flex: none;
    font-size: 14px;
    padding: 6px 8px;
  }
}
  /* Keep buttons (including Print) inline and wrapping neatly */
.actions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.actions button {
  flex: 1;
  max-width: 150px; /* adjust if needed */
}
@media (max-width: 480px) {
  .actions button {
    flex: none;
    font-size: 14px;
    padding: 6px 8px;
  }
}
  /* Keep buttons (including Print) inline and wrapping neatly */
.actions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.actions button {
  flex: 1;
  max-width: 150px; /* adjust if needed */
}
@media (max-width: 480px) {
  .actions button {
    flex: none;
    font-size: 14px;
    padding: 6px 8px;
  }
}

/* Ensure sign-out button is visible on mobile */
#signOutBtn {
  display: inline-block !important;
  visibility: visible !important;
  background: #e33;
  color: #fff;
  border: none;
}
.header-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
  /* Keep action buttons (incl. Print) on one line and wrap neatly on phones */
.actions{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:10px;
}
.actions button{
  flex:1;
  max-width:150px; /* adjust if you want wider */
}
@media (max-width:480px){
  .actions button{
    flex:none;
    font-size:14px;
    padding:6px 8px;
  }
}

/* Show the signed-in controls only when authenticated */
#signedInControls{ display:none; }
body.authed #signedInControls{ display:flex; gap:8px; flex-wrap:wrap; }

/* Make the Sign out button clearly visible */
#signOutBtn{
  background:#e33;
  color:#fff;
  border:none;
}
  </style>
</head>
<body>
<header>
  <div class="header-inner">
    <h1 id="appTitle">Ryan WP Stats</h1>
    <div style="display:flex;gap:8px;align-items:center">
      <span id="appVersion" class="status-pill">v21-rebuild</span>
      <span id="cloudStatus" class="status-pill">Not signed in</span>
      <button id="menuBtn" class="menu-btn">â˜°</button>
      <div id="menuPanel" class="menu-panel">
        <div style="padding:8px;border-bottom:1px solid #eee;margin-bottom:6px">
          <div style="font-weight:600;margin:4px 0 6px;">Account</div>
          <div id="loginWhenSignedOut">
            <input id="loginEmail" type="email" placeholder="you@example.com" inputmode="email" autocapitalize="none" autocomplete="email" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:6px">
            <input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:6px">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button id="signInBtn" class="btn-sm" type="button">Sign in</button>
              <button id="signUpBtn" class="btn-sm" type="button">Create account</button>
            </div>
          </div>
          <div id="signedInControls" style="display:none;gap:8px;flex-wrap:wrap">
            <button id="signOutBtn" class="btn-sm danger" type="button">Sign out</button>
          </div>
          <div id="authMsg" class="fine" style="min-height:16px;margin-top:6px"></div>
        </div>
        <button id="syncNowBtn">Sync now</button>
        <button id="exportCSV">Export CSV</button>
        <button id="exportJSON">Backup JSON</button>
        <label for="importJSON" style="display:block"><span style="display:block;padding:10px">Import JSON</span></label>
        <input id="importJSON" type="file" accept=".json" style="display:none">
        <button id="resetAll" class="danger">Reset (local)</button>
        <div id="diag" class="fine" style="padding:8px 10px 0 10px;color:#666"></div>
      </div>
    </div>
  </div>
</header>

<nav class="tabs">
  <button class="tab active" data-tab="record">Record</button>
  <button class="tab" data-tab="games">Games</button>
  <button class="tab" data-tab="season">Season</button>
  <button class="tab" data-tab="trends">Trends</button>
  <button class="tab" data-tab="settings">Settings</button>
</nav>

<main>
  <section id="record" class="panel active">
    <div class="card">
      <div class="meta">
        <input id="date" type="date">
        <input id="opponent" type="text" placeholder="Opponent">
      </div>

      <div class="timer" title="Tap time to edit mm:ss">
        <div class="label">Playing Time</div>
        <div id="ptTime" class="time">00:00</div>
        <button id="ptToggle" class="btn-sm" type="button">Start</button>
        <button id="ptReset" class="btn-sm" type="button">Reset</button>
      </div>

      <div id="rows"></div>

      <div class="grid2" style="margin-top:10px">
        <div class="card">
          <div class="controls row"><div class="label">Points</div><div></div><div class="counter" id="points">0</div><div></div></div>
          <div class="controls row"><div class="label">Total Shots</div><div></div><div class="counter" id="shotsTotal">0</div><div></div></div>
          <div class="controls row"><div class="label">Total Goals</div><div></div><div class="counter" id="goalsTotal">0</div><div></div></div>
          <div class="controls row"><div class="label">Shot %</div><div></div><div class="counter" id="shotpct">-</div><div></div></div>
          <div class="fine" id="pctnote"></div>
        </div>
      </div>

      <div style="margin-top:10px">
        <label class="fine" for="notes">Notes</label>
        <textarea id="notes" placeholder="Game notes..."></textarea>
      </div>

      <div class="actions">
        <button id="undo" class="btn-sm" type="button">Undo</button>
        <button id="saveGame" class="primary" type="button">Save Game</button>
        <button id="newGame" type="button">New Game</button>
        <button id="print" class="btn-sm" type="button">Print</button>
      </div>
    </div>
  </section>

  <section id="games" class="panel"><div id="gamesList"></div></section>

  <section id="season" class="panel">
    <div class="card" style="margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="dlSeasonTotals" class="btn-sm" type="button">Download Season Totals CSV</button>
    </div>
    <div id="seasonTotals" class="card"></div>
  </section>

  <section id="trends" class="panel">
    <div class="card">
      <h3>Season Trends</h3>
      <canvas id="trendCanvas" height="260"></canvas>
      <div id="trendEmpty" class="fine" style="display:none;margin-top:8px">No games yet â€” save a game to see trends.</div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
        <label><input type="checkbox" id="t_goals" checked> Goals</label>
        <label><input type="checkbox" id="t_shots" checked> Shots</label>
        <label><input type="checkbox" id="t_points" checked> Points</label>
        <label><input type="checkbox" id="t_minutes" checked> Minutes</label>
      </div>
    </div>
  </section>

  <section id="settings" class="panel">
    <div class="card">
      <h3>Settings</h3>
      <label><input type="checkbox" id="pctMode"> Use Shot% = shots / goals (non-standard)</label>
      <p class="fine">Default is the standard: Shot% = goals / shots.</p>
      <label style="display:block;margin-top:10px">
        <input type="checkbox" id="autoSaveCSV" checked> Auto-save game CSV after Save
      </label>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Supabase client (uses your project URL + anon key)
  const supabase = window.supabase.createClient(
    "https://hlcxhyrdumxfrlqgkcvf.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhsY3hoeXJkdW14ZnJscWdrY3ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MDI0ODcsImV4cCI6MjA3MDI3ODQ4N30.ebYblf4mg64QMLf3M-QH8Q6TWId6BFd-CQcwAMGqQfw"
  );
</script>
<script>
/* ========= App JS (safe rebuild) ========= */
const LS_KEY='wp_v21_rebuild', DRAFT_KEY='wp_v21_rebuild_draft';
const statDefs=[
  {key:'shot',label:'Shot'},{key:'goal',label:'Goal'},{key:'assist',label:'Assist'},
  {key:'steal',label:'Steal'},{key:'block',label:'Block'},
  {key:'five_m_attempt',label:'5M Attempt'},{key:'five_m_goal',label:'5M Goal'},{key:'five_m_drawn',label:'5M Drawn'},
  {key:'exclusion',label:'Exclusion'},{key:'exclusion_drawn',label:'Exclusion Drawn'}
];

const today=()=>new Date().toISOString().slice(0,10);
const blankGame=()=>{const g={date:today(),opponent:'',notes:'',stats:{},pt_seconds:0}; statDefs.forEach(s=>g.stats[s.key]=0); return g;};
const load=()=>{try{return JSON.parse(localStorage.getItem(LS_KEY))||{games:[],settings:{pctMode:false,autoSaveCSV:true},user:null};}catch{return {games:[],settings:{pctMode:false,autoSaveCSV:true},user:null};}};
const save=(s)=>localStorage.setItem(LS_KEY,JSON.stringify(s));
const loadDraft=()=>{try{return JSON.parse(localStorage.getItem(DRAFT_KEY))||null;}catch{return null;}};
const saveDraft=()=>localStorage.setItem(DRAFT_KEY,JSON.stringify(current));

let state=load(), current=loadDraft()||blankGame(), undoStack=[], timerId=null, lastTick=null;

const tabs=document.querySelectorAll('.tab');
tabs.forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); document.getElementById(b.dataset.tab).classList.add('active');
  if(b.dataset.tab==='games') renderGames();
  if(b.dataset.tab==='season') renderSeason();
  if(b.dataset.tab==='trends') drawTrends();
}));

const menuBtn=document.getElementById('menuBtn'), menuPanel=document.getElementById('menuPanel');
menuBtn.addEventListener('click',()=>menuPanel.style.display=menuPanel.style.display==='block'?'none':'block');
document.addEventListener('click',(e)=>{ if(!menuPanel.contains(e.target)&&e.target!==menuBtn) menuPanel.style.display='none'; });

/* Build stat rows */
const rowsDiv=document.getElementById('rows');
function buildRows(){
  rowsDiv.innerHTML='';
  statDefs.forEach(s=>{
    const row=document.createElement('div'); row.className='row controls';
    row.innerHTML=`<div class="label">${s.label}</div>
      <button class="dec" data-k="${s.key}" type="button">âˆ’</button>
      <div class="counter" id="c_${s.key}">0</div>
      <button class="inc" data-k="${s.key}" type="button">+</button>`;
    rowsDiv.appendChild(row);
  });
  rowsDiv.querySelectorAll('.inc').forEach(b=>b.addEventListener('click',()=>inc(b.dataset.k)));
  rowsDiv.querySelectorAll('.dec').forEach(b=>b.addEventListener('click',()=>dec(b.dataset.k)));
}
buildRows();

/* Inputs & timer */
const dateEl=document.getElementById('date');
const oppEl=document.getElementById('opponent');
const notesEl=document.getElementById('notes');
const ptTimeEl=document.getElementById('ptTime');
const ptToggle=document.getElementById('ptToggle');
const ptReset=document.getElementById('ptReset');

const fmtTime=(s)=>String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0');
const parseMMSS=(v)=>{const m=(v||'').trim().match(/^([0-9]{1,2}):([0-5][0-9])$/); return m? (+m[1]*60+ +m[2]) : null;};
function tickTimer(){const now=Date.now(); if(lastTick!=null){const d=Math.floor((now-lastTick)/1000); if(d>0){current.pt_seconds+=d; ptTimeEl.textContent=fmtTime(current.pt_seconds); saveDraft();}} lastTick=now;}
function startTimer(){if(timerId)return; lastTick=Date.now(); timerId=setInterval(tickTimer,1000); ptToggle.textContent='Stop'; ptToggle.classList.add('running');}
function stopTimer(){if(!timerId)return; tickTimer(); clearInterval(timerId); timerId=null; lastTick=null; ptToggle.textContent='Start'; ptToggle.classList.remove('running');}
ptToggle.addEventListener('click',()=>{if(timerId)stopTimer(); else startTimer();});
ptReset.addEventListener('click',()=>{if(timerId)stopTimer(); current.pt_seconds=0; ptTimeEl.textContent=fmtTime(0); saveDraft();});
ptTimeEl.addEventListener('click',()=>{const val=prompt('Enter playing time (mm:ss):', fmtTime(current.pt_seconds||0)); if(!val)return; const sec=parseMMSS(val); if(sec==null){alert('Use mm:ss'); return;} if(timerId)stopTimer(); current.pt_seconds=sec; ptTimeEl.textContent=fmtTime(sec); saveDraft();});

dateEl.value=current.date; oppEl.value=current.opponent; notesEl.value=current.notes||''; ptTimeEl.textContent=fmtTime(current.pt_seconds||0);
dateEl.addEventListener('change',()=>{current.date=dateEl.value; saveDraft();});
oppEl.addEventListener('input',()=>{current.opponent=oppEl.value; saveDraft();});
notesEl.addEventListener('input',()=>{current.notes=notesEl.value; saveDraft();});

/* Derived UI */
const pct=(g,s,mode)=>(!s||s<=0)?'-':(mode?(s/g):(g/s)).toFixed(2);
function renderCurrent(){
  statDefs.forEach(s=>document.getElementById('c_'+s.key).textContent=current.stats[s.key]);
  const goals=current.stats.goal, shots=current.stats.shot, assists=current.stats.assist;
  document.getElementById('points').textContent=goals+assists;
  document.getElementById('shotpct').textContent=pct(goals,shots,state.settings.pctMode);
  document.getElementById('shotsTotal').textContent=shots;
  document.getElementById('goalsTotal').textContent=goals;
  document.getElementById('pctnote').textContent= state.settings.pctMode ? 'Shot% = shots / goals' : 'Shot% = goals / shots (standard)';
}
renderCurrent();

/* Undo / +/- */
function pushUndo(s){undoStack.push(s); if(undoStack.length>100)undoStack.shift();}
function inc(k){pushUndo(JSON.parse(JSON.stringify(current))); current.stats[k]++; if(k==='five_m_attempt') current.stats.shot++; if(k==='five_m_goal'){ current.stats.goal++; current.stats.shot++; } renderCurrent(); saveDraft();}
function dec(k){pushUndo(JSON.parse(JSON.stringify(current))); if(current.stats[k]>0) current.stats[k]--; if(k==='five_m_attempt'&&current.stats.shot>0) current.stats.shot--; if(k==='five_m_goal'){ if(current.stats.goal>0) current.stats.goal--; if(current.stats.shot>0) current.stats.shot--; } renderCurrent(); saveDraft();}
document.getElementById('undo').addEventListener('click',()=>{ if(!undoStack.length)return; current=undoStack.pop(); dateEl.value=current.date; oppEl.value=current.opponent; notesEl.value=current.notes||''; ptTimeEl.textContent=fmtTime(current.pt_seconds||0); renderCurrent(); saveDraft(); });

/* CSV helpers */
function gameToCSV(g){
  const H=['date','opponent','notes','minutes','Shot','Goal','Assist','Steal','Block','5M Attempt','5M Goal','5M Drawn','Exclusion','Exclusion Drawn','Points','ShotPct'];
  const goals=g.stats.goal, shots=g.stats.shot, ass=g.stats.assist; const points=goals+ass;
  const shotpct=(shots?(goals/shots).toFixed(2):'-'); const mins=Math.round((g.pt_seconds||0)/60);
  const C=[g.date,(g.opponent||''),(g.notes||'').replace(/\n/g,' ').replace(/,/g,';'),mins,g.stats.shot,g.stats.goal,g.stats.assist,g.stats.steal,g.stats.block,g.stats.five_m_attempt,g.stats.five_m_goal,g.stats.five_m_drawn,g.stats.exclusion,g.stats.exclusion_drawn,points,shotpct];
  return H.join(',')+'\n'+C.join(',')+'\n';
}
function downloadCSVForGame(g){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([gameToCSV(g)],{type:'text/csv;charset=utf-8'}));
  a.download=`ryan_wp_${g.date}_${(g.opponent||'opponent').replace(/\W+/g,'_')}.csv`;
  a.click();
}

/* Save / New / Print */
async function saveAndMaybeSync(){
  const snap=JSON.parse(JSON.stringify(current));
  state.games.unshift(snap); save(state);
  localStorage.removeItem(DRAFT_KEY);
  renderGames(); renderSeason(); drawTrends();
  if(state.settings.autoSaveCSV) downloadCSVForGame(snap);
  await pushLocalToCloud(); await pullCloudToLocal(); setCloud('Synced');
}
document.getElementById('saveGame').addEventListener('click',()=>{ saveAndMaybeSync().then(()=>alert('Game saved.')); });
document.getElementById('newGame').addEventListener('click',()=>{ 
  const hasData=Object.values(current.stats).some(v=>v>0)||current.opponent||(current.notes||'').trim()||(current.pt_seconds>0); 
  if(hasData&&!confirm('Start a new game? Unsaved changes will be lost.')) return; 
  stopTimer(); current=blankGame(); undoStack=[]; dateEl.value=current.date; oppEl.value=''; notesEl.value=''; ptTimeEl.textContent=fmtTime(0); renderCurrent(); saveDraft(); 
});
document.getElementById('print').addEventListener('click',()=>{ window.print(); });

/* Games list */
function escapeHtml(s){return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function renderGames(){
  const wrap=document.getElementById('gamesList'); 
  wrap.innerHTML=''; 
  if(!state.games.length){wrap.innerHTML="<div class='card'>No games yet.</div>"; return;}
  state.games.forEach((g,idx)=>{
    const mmss=fmtTime(g.pt_seconds||0);
    const s=g.stats;
    const details =
      `Shots: ${s.shot} â€¢ Goals: ${s.goal} â€¢ Assists: ${s.assist} â€¢ ` +
      `Steals: ${s.steal} â€¢ Blocks: ${s.block} â€¢ ` +
      `5M Att: ${s.five_m_attempt} â€¢ 5M Goal: ${s.five_m_goal} â€¢ 5M Drawn: ${s.five_m_drawn} â€¢ ` +
      `Excl: ${s.exclusion} â€¢ Excl Drawn: ${s.exclusion_drawn} â€¢ Minutes: ${mmss}`;
    const div=document.createElement('div'); 
    div.className='card';
    div.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <strong>${g.date} â€” ${escapeHtml(g.opponent||'Opponent')}</strong>
        <div>
          <button class='btn-sm' data-dl='${idx}' type="button">Download CSV</button>
          <button class='btn-sm' data-edit='${idx}' type="button">Edit</button>
          <button class='btn-sm danger' data-del='${idx}' type="button">Delete</button>
        </div>
      </div>
      <div class="fine">${details}</div>`;
    wrap.appendChild(div);
  });
  wrap.querySelectorAll('[data-dl]').forEach(b=>b.addEventListener('click',()=>downloadCSVForGame(state.games[+b.dataset.dl])));
  wrap.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click', async ()=>{
    const i=+b.dataset.del; const g=state.games[i]; if(!g) return;
    if(!confirm('Delete this game?')) return;
    try{
      if(state.user && g.cloud_id){
        const { error } = await supabase.from('games').delete().eq('id', g.cloud_id);
        if(error){ alert('Cloud delete failed: '+error.message); return; }
      }
    }catch(e){ alert('Cloud delete failed: '+(e.message||e)); return; }
    state.games.splice(i,1);
    save(state);
    renderGames(); renderSeason(); drawTrends();
    if(state.user) await pullCloudToLocal();
  }));
  wrap.querySelectorAll('[data-edit]').forEach(b=>b.addEventListener('click',()=>{
    const i=+b.dataset.edit; const g=state.games[i]; if(!g) return;
    if(!confirm('Load this game into the editor? Current draft will be replaced.')) return;
    stopTimer(); current=JSON.parse(JSON.stringify(g)); undoStack=[];
    dateEl.value=current.date; oppEl.value=current.opponent; notesEl.value=current.notes||'';
    ptTimeEl.textContent=fmtTime(current.pt_seconds||0);
    renderCurrent(); saveDraft();
    document.querySelector('.tab[data-tab="record"]').click();
  }));
}

/* Season totals */
function renderSeason(){
  const agg={shot:0,goal:0,assist:0,steal:0,block:0,five_m_attempt:0,five_m_goal:0,five_m_drawn:0,exclusion:0,exclusion_drawn:0};
  let tsum=0; state.games.forEach(g=>{ for(const k in agg) agg[k]+=g.stats[k]||0; tsum+=(g.pt_seconds||0); });
  const gsum=agg.goal, ssum=agg.shot, asum=agg.assist; const n=state.games.length||0; const avgSec=n?Math.round(tsum/n):0;

  document.getElementById('seasonTotals').innerHTML=`<h3>Season Totals</h3><table><tbody>
<tr><th>Shot</th><td class='right'>${agg.shot}</td></tr>
<tr><th>Goal</th><td class='right'>${agg.goal}</td></tr>
<tr><th>Assist</th><td class='right'>${agg.assist}</td></tr>
<tr><th>Steal</th><td class='right'>${agg.steal}</td></tr>
<tr><th>Block</th><td class='right'>${agg.block}</td></tr>
<tr><th>5M Attempt</th><td class='right'>${agg.five_m_attempt}</td></tr>
<tr><th>5M Goal</th><td class='right'>${agg.five_m_goal}</td></tr>
<tr><th>5M Drawn</th><td class='right'>${agg.five_m_drawn}</td></tr>
<tr><th>Exclusion</th><td class='right'>${agg.exclusion}</td></tr>
<tr><th>Exclusion Drawn</th><td class='right'>${agg.exclusion_drawn}</td></tr>
<tr><th>Points</th><td class='right'>${gsum+asum}</td></tr>
<tr><th>Shot %</th><td class='right'>${ssum?(gsum/ssum).toFixed(2):'-'}</td></tr>
<tr><th>Total Minutes</th><td class='right'>${fmtTime(tsum)}</td></tr>
<tr><th>Avg Minutes/Game</th><td class='right'>${fmtTime(avgSec)}</td></tr>
</tbody></table>`;

  document.getElementById('dlSeasonTotals').onclick=()=>{
    const order=['Shot','Goal','Assist','Steal','Block','5M Attempt','5M Goal','5M Drawn','Exclusion','Exclusion Drawn','Points','ShotPct','TotalMinutes','AvgMinutesPerGame'];
    const row=[agg.shot,agg.goal,agg.assist,agg.steal,agg.block,agg.five_m_attempt,agg.five_m_goal,agg.five_m_drawn,agg.exclusion,agg.exclusion_drawn,gsum+asum, ssum?(gsum/ssum).toFixed(2):'-', fmtTime(tsum), fmtTime(avgSec)];
    const csv='Metric,'+order.join(',')+'\nTotals,'+row.join(',')+'\n';
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'})); a.download='ryan_wp_season_totals.csv'; a.click();
  };
}

/* Trends */
function drawTrends() {
  const cvs = document.getElementById('trendCanvas');
  const ctx = cvs.getContext('2d');
  const empty = document.getElementById('trendEmpty');

  if (!state.games.length) { ctx.clearRect(0,0,cvs.width,cvs.height); if (empty) empty.style.display='block'; return; }
  if (empty) empty.style.display = 'none';

  const cssRect = cvs.getBoundingClientRect();
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const w = Math.max(320, Math.floor(cssRect.width));
  const h = Math.floor(cssRect.height || 240);
  cvs.width = Math.floor(w * dpr); cvs.height = Math.floor(h * dpr);
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.clearRect(0,0,w,h);

  const games   = state.games.slice().reverse();
  const goals   = games.map(g => g.stats.goal   || 0);
  const shots   = games.map(g => g.stats.shot   || 0);
  const points  = games.map(g => (g.stats.goal||0) + (g.stats.assist||0));
  const minutes = games.map(g => Math.round((g.pt_seconds||0)/60));

  const series=[], add=(id,name,data,color)=>{ const el=document.getElementById(id); if(el&&el.checked) series.push({name,data,color}); };
  add('t_goals','Goals',goals,'#2e7d32'); add('t_shots','Shots',shots,'#1565c0'); add('t_points','Points',points,'#8e24aa'); add('t_minutes','Minutes',minutes,'#6d4c41');

  const pad={l:36,r:10,t:14,b:26}, pw=w-pad.l-pad.r, ph=h-pad.t-pad.b, N=(series[0]?.data.length||1);
  const maxY=Math.max(5,...series.flatMap(s=>s.data));
  const xFor=(i)=>(N===1)? pad.l+pw/2 : pad.l + (i*(pw/(N-1)));
  const yFor=(v)=> pad.t + ph - (v/maxY)*ph;

  ctx.strokeStyle='#d8d8de'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad.l,pad.t); ctx.lineTo(pad.l,pad.t+ph); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(pad.l,pad.t+ph); ctx.lineTo(pad.l+pw,pad.t+ph); ctx.stroke();

  ctx.fillStyle='#666'; ctx.font='12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
  const ticks=4;
  for(let i=0;i<=ticks;i++){ const val=Math.round((maxY*i)/ticks); const y=yFor(val);
    ctx.strokeStyle='#f0f0f4'; ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+pw,y); ctx.stroke();
    ctx.fillStyle='#666'; ctx.fillText(String(val),4,y+4);
  }
  ctx.fillStyle='#666';
  games.forEach((_,i)=>{ const x=xFor(i); const label=String(i+1); ctx.fillText(label,x-ctx.measureText(label).width/2,pad.t+ph+16); });

  series.forEach(s=>{
    ctx.strokeStyle=s.color; ctx.lineWidth=2; ctx.beginPath();
    s.data.forEach((v,i)=>{ const x=xFor(i),y=yFor(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
    ctx.stroke(); ctx.fillStyle=s.color;
    s.data.forEach((v,i)=>{ const x=xFor(i),y=yFor(v); ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); });
  });
}
['t_goals','t_shots','t_points','t_minutes'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('change',drawTrends); });
addEventListener('resize',drawTrends);
document.addEventListener('visibilitychange',()=>{ if(!document.hidden) drawTrends(); });

/* Settings */
document.getElementById('pctMode').addEventListener('change',e=>{ state.settings.pctMode=!!e.target.checked; save(state); renderCurrent(); renderGames(); renderSeason(); drawTrends(); });
document.getElementById('autoSaveCSV').addEventListener('change',e=>{ state.settings.autoSaveCSV=!!e.target.checked; save(state); });

/* Export/Import/Reset */
function toCSV(){
  const H=['date','opponent','notes','minutes','Shot','Goal','Assist','Steal','Block','5M Attempt','5M Goal','5M Drawn','Exclusion','Exclusion Drawn','Points','ShotPct']; const rows=[H.join(',')];
  state.games.forEach(g=>{ const goals=g.stats.goal,shots=g.stats.shot,ass=g.stats.assist; const points=goals+ass; const shotpct=(shots?(goals/shots).toFixed(2):'-'); const mins=Math.round((g.pt_seconds||0)/60);
    const C=[g.date,(g.opponent||''),(g.notes||'').replace(/\n/g,' ').replace(/,/g,';'),mins,g.stats.shot,g.stats.goal,g.stats.assist,g.stats.steal,g.stats.block,g.stats.five_m_attempt,g.stats.five_m_goal,g.stats.five_m_drawn,g.stats.exclusion,g.stats.exclusion_drawn,points,shotpct]; 
    rows.push(C.join(','));
  });
  return rows.join('\n')+'\n';
}
document.getElementById('exportCSV').addEventListener('click',()=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([toCSV()],{type:'text/csv;charset=utf-8'})); a.download='ryan_wp_stats.csv'; a.click(); });
document.getElementById('exportJSON').addEventListener('click',()=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(state,null,2)],{type:'application/json'})); a.download='ryan_wp_backup.json'; a.click(); });
document.getElementById('importJSON').addEventListener('change',(e)=>{ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(!obj||typeof obj!=='object'||!Array.isArray(obj.games)) throw new Error('Invalid backup'); state=obj; save(state); alert('Imported.'); renderGames(); renderSeason(); drawTrends(); renderCurrent(); }catch(err){ alert('Import failed: '+err.message);} }; r.readAsText(f); });
document.getElementById('resetAll').addEventListener('click',()=>{ if(!confirm('Erase ALL local data on this device?')) return; state={games:[],settings:{pctMode:false,autoSaveCSV:true},user:null}; save(state); localStorage.removeItem(DRAFT_KEY); current=blankGame(); undoStack=[]; dateEl.value=current.date; oppEl.value=''; notesEl.value=''; ptTimeEl.textContent=fmtTime(0); renderCurrent(); renderGames(); renderSeason(); drawTrends(); });

/* Auth & realtime */
const cloudStatus=document.getElementById('cloudStatus'); const setCloud=(t)=>cloudStatus.textContent=t;
const authMsg=document.getElementById('authMsg'); const emailInput=document.getElementById('loginEmail'); const passInput=document.getElementById('loginPassword');
const signedInControls=document.getElementById('signedInControls'); const loginWhenSignedOut=document.getElementById('loginWhenSignedOut');

document.getElementById('signInBtn').addEventListener('click', async (e)=>{
  e.preventDefault();
  const email=(emailInput.value||'').trim(); const password=(passInput.value||'').trim();
  if(!email||!password){ authMsg.textContent='Enter email and password'; return; }
  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if(error) authMsg.textContent='Login failed: '+error.message;
});
document.getElementById('signUpBtn').addEventListener('click', async (e)=>{
  e.preventDefault();
  const email=(emailInput.value||'').trim(); const password=(passInput.value||'').trim();
  if(!email||!password){ authMsg.textContent='Enter email and password'; return; }
  const { error } = await supabase.auth.signUp({ email, password });
  if(error) authMsg.textContent='Sign up failed: '+error.message;
  else authMsg.textContent='Account created. Sign in next.';
});
document.getElementById('signOutBtn').addEventListener('click', async ()=>{ await supabase.auth.signOut(); });

let rtSub=null;
function subscribeRealtime(){
  if(rtSub) return;
  rtSub = supabase.channel('games-realtime')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'games' }, () => pullCloudToLocal())
    .subscribe();
}
function unsubscribeRealtime(){ if(rtSub){ supabase.removeChannel(rtSub); rtSub=null; } }

supabase.auth.onAuthStateChange(async (_evt, session)=>{
  const signed = !!(session && session.user);
  if(signed){
    state.user = session.user; save(state);
    document.body.classList.add('authed');
    setCloud('Signed in'); authMsg.textContent='';
    loginWhenSignedOut.style.display='none';
    signedInControls.style.display='flex';
    await pullCloudToLocal(); subscribeRealtime();
  }else{
    state.user = null; save(state);
    document.body.classList.remove('authed');
    setCloud('Not signed in');
    signedInControls.style.display='none';
    loginWhenSignedOut.style.display='block';
    unsubscribeRealtime();
  }
});

// If already signed in at load, pull immediately
(async () => {
  const { data } = await supabase.auth.getSession();
  if (data && data.session && data.session.user) {
    state.user = data.session.user; save(state);
    setCloud('Signed in');
    loginWhenSignedOut.style.display = 'none';
    signedInControls.style.display = 'flex';
    await pullCloudToLocal();
    subscribeRealtime();
  }
})();

/* Cloud sync */
async function pushLocalToCloud(){
  if(!state.user) return;
  setCloud('Syncingâ€¦');
  for(const g of state.games){
    if(!g.cloud_id){
      const payload={ user_id: state.user.id, date:g.date, opponent:g.opponent, notes:g.notes, stats:g.stats, pt_seconds:g.pt_seconds||0 };
      try{
        const {data,error}=await supabase.from('games').insert(payload).select();
        if(!error&&data&&data[0]) g.cloud_id=data[0].id;
      }catch(e){}
    }
  }
  save(state);
}
async function pullCloudToLocal() {
  if (!state.user) { const d=document.getElementById('diag'); if(d) d.textContent='Not signed in â€“ skip pull'; return; }
  const d=document.getElementById('diag');
  try {
    if (d) d.textContent = 'Pulling from cloudâ€¦';
    const { data, error } = await supabase.from('games').select('*').order('created_at',{ ascending:false });
    if (error) { if (d) d.textContent = 'Pull error: ' + error.message; return; }
    const cloud = data || [];
    const known = new Set(state.games.map(g => g.cloud_id).filter(Boolean));
    cloud.forEach(r => {
      if (!known.has(r.id)) {
        state.games.unshift({ date:r.date, opponent:r.opponent, notes:r.notes, stats:r.stats, pt_seconds:r.pt_seconds||0, cloud_id:r.id });
      }
    });
    save(state); renderGames(); renderSeason(); drawTrends();
    if (d) d.textContent = `Synced â€¢ local: ${state.games.length} â€¢ cloud: ${cloud.length}`;
  } catch (e) {
    const msg=(e&&e.message)?e.message:String(e);
    const d=document.getElementById('diag'); if(d) d.textContent='Pull exception: '+msg;
  }
}
document.getElementById('syncNowBtn').addEventListener('click', async ()=>{ await pushLocalToCloud(); await pullCloudToLocal(); });

/* Init */
function init(){
  document.getElementById('pctMode').checked=!!state.settings.pctMode;
  document.getElementById('autoSaveCSV').checked=!!state.settings.autoSaveCSV;
  renderGames(); renderSeason(); drawTrends();
  if('serviceWorker' in navigator){
    navigator.serviceWorker.getRegistrations().then(regs=>Promise.all(regs.map(r=>r.unregister()))).finally(()=>navigator.serviceWorker.register('sw.js?v=21rebuild'));
  }
}
init();
/* ---------------- Player Name Capture ---------------- */
let playerName = localStorage.getItem('playerName');
if (!playerName) {
  const first = prompt('Enter player first name:').trim();
  const last = prompt('Enter player last name:').trim();
  playerName = `${first} ${last}`;
  localStorage.setItem('playerName', playerName);
}
document.querySelector('header h1').textContent = `${playerName.split(' ')[0]} Polo Stats`;
</script>
</body>
</html>
