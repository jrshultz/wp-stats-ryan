<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>Ryan WP Stats</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a3d2e">
<style>
:root{
  --green:#0a3d2e;
  --gold:#f0b400;
  --bg:#f7f7f9;
  --card:#fff;
  --line:#e9e9ef;
}
*{box-sizing:border-box;}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:var(--bg);color:#111;}
header{position:sticky;top:0;z-index:5;background:var(--green);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:12px 14px;}
.brand{line-height:1}
.brand h1{margin:0;font-size:20px;font-weight:700;}
.brand small{display:block;opacity:.8}
.hamburger{border:none;background:transparent;color:#fff;font-size:26px;line-height:1;cursor:pointer;}
.menu{position:fixed;right:10px;top:56px;background:#fff;border:1px solid #ddd;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.12);display:none;z-index:6}
.menu.open{display:block;}
.menu ul{margin:0;padding:8px;list-style:none;min-width:180px;}
.menu li button{width:100%;text-align:left;padding:10px 12px;border:none;background:#fff;border-radius:8px;}
.menu li button:hover{background:#f3f3f6;}
.tabs{display:flex;position:sticky;top:56px;background:#fff;border-bottom:2px solid var(--gold);z-index:4}
.tab{flex:1;padding:12px;border:none;background:#fff;color:#1a1a1a}
.tab.active{border-bottom:3px solid var(--gold);font-weight:600}
main{padding:12px;}
.panel{display:none}
.panel.active{display:block}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;}
.meta{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
.meta input{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd;}
.controls{display:grid;grid-template-columns:1fr 86px 82px 86px;gap:8px;align-items:center;}
.label{font-weight:600;}
.counter{text-align:center;padding:12px;border:1px solid #ddd;border-radius:10px;background:#fff;font-size:18px;}
.row{padding:6px 0;border-bottom:1px solid #f1f1f4;}
.row:last-child{border-bottom:none;}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
button{border:1px solid #ddd;background:#fff;padding:12px;border-radius:12px;font-size:16px;}
.btn-sm{padding:8px 10px;font-size:14px;border-radius:10px;}
.primary{background:var(--gold);color:#111;border:none;font-weight:700;}
.danger{background:#e33;color:#fff;border:none;}
.fine{color:#666;font-size:12px;}
#notes{width:100%;min-height:90px;padding:12px;border-radius:10px;border:1px solid #ddd;}
.right{text-align:right;}
.summary .row{grid-template-columns:1fr 1fr !important;}
.summary .label{font-weight:600;}
.summary .counter{justify-self:end;min-width:72px;}
@media (max-width:740px){
  .controls{grid-template-columns:1fr 78px 70px 78px;}
  button{font-size:15px;}
}
@media print{
  header,.tabs,.menu,.danger,.primary,.btn-sm{display:none!important;}
  body{background:#fff}
  .card{border:none}
}
</style>
</head>
<body>
<header>
  <div class="brand">
    <h1>Ryan WP Stats</h1>
    <small>Mira Costa High School</small>
  </div>
  <button class="hamburger" id="menuBtn">☰</button>
  <div class="menu" id="menu">
    <ul>
      <li><button id="csvBtn">Export CSV</button></li>
      <li><button id="backupBtn">Backup (JSON)</button></li>
      <li><button id="importLabel">Import Backup</button></li>
      <li><button id="resetBtn" class="danger">Reset All</button></li>
    </ul>
  </div>
</header>

<nav class="tabs">
  <button class="tab active" data-tab="record">Record</button>
  <button class="tab" data-tab="games">Games</button>
  <button class="tab" data-tab="season">Season</button>
  <button class="tab" data-tab="settings">Settings</button>
</nav>

<main>
  <section id="record" class="panel active">
    <div class="card">
      <div class="meta">
        <input id="date" type="date"/>
        <input id="opponent" type="text" placeholder="Opponent"/>
      </div>

      <div id="rows"></div>

      <div class="card summary" style="margin-top:10px;">
        <div class="controls row" style="grid-template-columns:1fr 1fr;">
          <div class="label">Points</div><div class="counter" id="points">0</div>
        </div>
        <div class="controls row" style="grid-template-columns:1fr 1fr;">
          <div class="label">Total Shots</div><div class="counter" id="shotsTotal">0</div>
        </div>
        <div class="controls row" style="grid-template-columns:1fr 1fr;">
          <div class="label">Total Goals</div><div class="counter" id="goalsTotal">0</div>
        </div>
        <div class="controls row" style="grid-template-columns:1fr 1fr;">
          <div class="label">Shot %</div><div class="counter" id="shotpct">-</div>
        </div>
        <div class="fine" id="pctnote"></div>
      </div>

      <div style="margin-top:10px;">
        <label class="fine" for="notes">Notes</label>
        <textarea id="notes" placeholder="Game notes..."></textarea>
      </div>

      <div class="actions">
        <button id="undo" class="btn-sm">Undo</button>
        <button id="saveGame" class="primary">Save Game</button>
        <button id="newGame">New Game</button>
        <button id="print" class="btn-sm">Print</button>
      </div>
    </div>
  </section>

  <section id="games" class="panel">
    <div id="gamesList"></div>
  </section>

  <section id="season" class="panel">
    <div id="seasonTotals" class="card"></div>
    <div class="card" style="margin-top:10px;">
      <canvas id="trend" height="220"></canvas>
    </div>
  </section>

  <section id="settings" class="panel">
    <div class="card">
      <h3>Settings</h3>
      <label><input type="checkbox" id="pctMode"> Use Shot% = shots / goals (non-standard)</label>
      <p class="fine">Default is the standard: Shot% = goals / shots.</p>
    </div>
  </section>
</main>

<input id="importJSON" type="file" accept=".json" style="display:none"/>

<script>
const menuBtn = document.getElementById('menuBtn');
const menu = document.getElementById('menu');
menuBtn.addEventListener('click', () => menu.classList.toggle('open'));
document.addEventListener('click', (e)=>{ if(!menu.contains(e.target) && e.target!==menuBtn) menu.classList.remove('open'); });

const LS_KEY = "wp_ryan_stats_v1";
const DRAFT_KEY = "wp_ryan_stats_v1_draft";

const statDefs = [
  { key:"shot", label:"Shot" },
  { key:"goal", label:"Goal" },
  { key:"assist", label:"Assist" },
  { key:"steal", label:"Steal" },
  { key:"block", label:"Block" },
  { key:"five_m_attempt", label:"5M Attempt" },
  { key:"five_m_goal", label:"5M Goal" },
  { key:"five_m_drawn", label:"5M Drawn" },
  { key:"exclusion", label:"Exclusion" },
  { key:"exclusion_drawn", label:"Exclusion Drawn" }
];

function today(){ return new Date().toISOString().slice(0,10); }
function blankGame(){ const g = { date: today(), opponent:"", notes:"", stats:{} }; statDefs.forEach(s=>g.stats[s.key]=0); return g; }
function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {games:[], settings:{pctMode:false}}; } catch{ return {games:[], settings:{pctMode:false}}; } }
function save(state){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function loadDraft(){ try{ return JSON.parse(localStorage.getItem(DRAFT_KEY)) || null; }catch{return null;} }
function saveDraft(){ localStorage.setItem(DRAFT_KEY, JSON.stringify(current)); }

let state = load();
let current = loadDraft() || blankGame();
let undoStack = [];

document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
    if(btn.dataset.tab==="games") renderGames();
    if(btn.dataset.tab==="season") { renderSeason(); drawTrend(); }
    if(btn.dataset.tab==="settings") { document.getElementById("pctMode").checked = !!state.settings.pctMode; }
  });
});

const rowsDiv = document.getElementById("rows");
function buildRows(){
  rowsDiv.innerHTML = "";
  statDefs.forEach(s=>{
    const row = document.createElement("div");
    row.className = "row controls";
    row.innerHTML = `
      <div class="label">${s.label}</div>
      <button class="dec" data-k="${s.key}">−</button>
      <div class="counter" id="c_${s.key}">0</div>
      <button class="inc" data-k="${s.key}">+</button>
    `;
    rowsDiv.appendChild(row);
  });
  rowsDiv.querySelectorAll(".inc").forEach(b=>b.addEventListener("click", ()=>inc(b.dataset.k)));
  rowsDiv.querySelectorAll(".dec").forEach(b=>b.addEventListener("click", ()=>dec(b.dataset.k)));
}
buildRows();

const dateEl = document.getElementById("date");
const oppEl = document.getElementById("opponent");
const notesEl = document.getElementById("notes");
dateEl.value = current.date;
oppEl.value = current.opponent;
notesEl.value = current.notes || "";
dateEl.addEventListener("change", ()=>{ current.date = dateEl.value; saveDraft(); });
oppEl.addEventListener("input", ()=>{ current.opponent = oppEl.value; saveDraft(); });
notesEl.addEventListener("input", ()=>{ current.notes = notesEl.value; saveDraft(); });

function pct(goals, shots, mode){ if(!shots||shots<=0) return "-"; return (mode ? (shots/goals):(goals/shots)).toFixed(2); }

function renderCurrent(){
  statDefs.forEach(s => { document.getElementById("c_"+s.key).textContent = current.stats[s.key]; });
  const goals = current.stats.goal;
  const shots = current.stats.shot;
  const assists = current.stats.assist;
  const points = goals + assists;
  document.getElementById("points").textContent = points;
  document.getElementById("shotpct").textContent = pct(goals, shots, state.settings.pctMode);
  document.getElementById("shotsTotal").textContent = shots;
  document.getElementById("goalsTotal").textContent = goals;
  document.getElementById("pctnote").textContent = state.settings.pctMode ? "Shot% = shots / goals" : "Shot% = goals / shots (standard)";
}
renderCurrent();

function pushUndo(snap){ undoStack.push(snap); if(undoStack.length>100) undoStack.shift(); }
function inc(k){
  pushUndo(JSON.parse(JSON.stringify(current)));
  current.stats[k]++;
  if(k==="five_m_attempt") current.stats.shot++;
  if(k==="five_m_goal") { current.stats.goal++; current.stats.shot++; }
  renderCurrent(); saveDraft();
}
function dec(k){
  pushUndo(JSON.parse(JSON.stringify(current)));
  if(current.stats[k]>0) current.stats[k]--;
  if(k==="five_m_attempt" && current.stats.shot>0) current.stats.shot--;
  if(k==="five_m_goal") { if(current.stats.goal>0) current.stats.goal--; if(current.stats.shot>0) current.stats.shot--; }
  renderCurrent(); saveDraft();
}
document.getElementById("undo").addEventListener("click", ()=>{ if(!undoStack.length) return; current = undoStack.pop(); dateEl.value=current.date; oppEl.value=current.opponent; notesEl.value=current.notes||""; renderCurrent(); saveDraft(); });

document.getElementById("saveGame").addEventListener("click", ()=>{
  const snap = JSON.parse(JSON.stringify(current));
  state.games.unshift(snap);
  save(state);
  localStorage.removeItem(DRAFT_KEY);
  alert("Game saved.");
  renderGames(); renderSeason();
});
document.getElementById("newGame").addEventListener("click", ()=>{
  const hasData = Object.values(current.stats).some(v=>v>0) || current.opponent || (current.notes||"").trim();
  if(hasData && !confirm("Start a new game? Unsaved changes will be lost.")) return;
  current = blankGame(); undoStack=[];
  dateEl.value=current.date; oppEl.value=""; notesEl.value="";
  renderCurrent(); saveDraft();
});
document.getElementById("print").addEventListener("click", ()=>window.print());

function renderGames(){
  const wrap = document.getElementById("gamesList");
  wrap.innerHTML = "";
  if(!state.games.length) { wrap.innerHTML = "<div class='card'>No games yet.</div>"; return; }
  state.games.forEach((g,idx)=>{
    const goals=g.stats.goal, shots=g.stats.shot, assists=g.stats.assist, points=goals+assists;
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
        <strong>${g.date} — ${g.opponent||"Opponent"}</strong>
        <div>
          <button class="btn-sm" data-edit="${idx}">Edit</button>
          <button class="btn-sm danger" data-del="${idx}">Delete</button>
        </div>
      </div>
      <table><tbody>
        ${statDefs.map(s=>`<tr><td>${s.label}</td><td class="right">${g.stats[s.key]||0}</td></tr>`).join("")}
        <tr><td>Points</td><td class="right">${points}</td></tr>
        <tr><td>Shot %</td><td class="right">${pct(goals,shots,state.settings.pctMode)}</td></tr>
      </tbody></table>
      ${g.notes ? `<div class="fine">Notes: ${escapeHtml(g.notes)}</div>` : ""}
    `;
    wrap.appendChild(div);
  });
  wrap.querySelectorAll("[data-del]").forEach(b=>b.addEventListener("click",()=>{ const i=+b.dataset.del; if(!confirm("Delete this game?")) return; state.games.splice(i,1); save(state); renderGames(); renderSeason(); }));
  wrap.querySelectorAll("[data-edit]").forEach(b=>b.addEventListener("click",()=>{
    const i=+b.dataset.edit; const g=state.games[i]; if(!g) return;
    if(!confirm("Load this game into the editor? Current draft will be replaced.")) return;
    current = JSON.parse(JSON.stringify(g));
    undoStack = [];
    dateEl.value=current.date; oppEl.value=current.opponent; notesEl.value=current.notes||"";
    renderCurrent(); saveDraft();
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    document.querySelector('.tab[data-tab="record"]').classList.add('active');
    document.getElementById('record').classList.add('active');
  }));
}
function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

function renderSeason(){
  const agg={}; statDefs.forEach(s=>agg[s.key]=0);
  state.games.forEach(g=>{ statDefs.forEach(s=>agg[s.key]+=g.stats[s.key]||0); });
  const gsum=agg.goal, ssum=agg.shot, asum=agg.assist;
  const html = `
    <h3>Season Totals</h3>
    <table><tbody>
      ${statDefs.map(s=>`<tr><th>${s.label}</th><td class="right">${agg[s.key]}</td></tr>`).join("")}
      <tr><th>Points</th><td class="right">${gsum+asum}</td></tr>
      <tr><th>Shot %</th><td class="right">${pct(gsum,ssum,state.settings.pctMode)}</td></tr>
    </tbody></table>`;
  document.getElementById("seasonTotals").innerHTML = html;
}
function drawTrend(){
  const canvas=document.getElementById("trend"); const ctx=canvas.getContext("2d");
  const w=canvas.width=canvas.clientWidth*(window.devicePixelRatio||1);
  const h=canvas.height=220*(window.devicePixelRatio||1);
  ctx.scale(window.devicePixelRatio||1, window.devicePixelRatio||1);
  ctx.clearRect(0,0,canvas.clientWidth,220);
  const goals=state.games.slice().reverse().map(g=>g.stats.goal||0);
  const shots=state.games.slice().reverse().map(g=>g.stats.shot||0);
  const pad={l:32,r:10,t:10,b:24}, plotW=canvas.clientWidth-pad.l-pad.r, plotH=220-pad.t-pad.b;
  const maxY=Math.max(5,...goals,...shots);
  ctx.strokeStyle="#ccc"; ctx.beginPath(); ctx.moveTo(pad.l,pad.t); ctx.lineTo(pad.l,pad.t+plotH); ctx.lineTo(pad.l+plotW,pad.t+plotH); ctx.stroke();
  ctx.fillStyle="#666"; ctx.font="12px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial";
  const steps=Math.min(5,maxY);
  for(let i=0;i<=steps;i++){ const yv=Math.round(i*maxY/steps); const y=pad.t+plotH-(yv/maxY)*plotH; ctx.fillText(String(yv),4,y+4); ctx.strokeStyle="#eee"; ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+plotW,y); ctx.stroke(); }
  function line(data,color){ ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath(); data.forEach((v,i)=>{ const x=pad.l+(i*(plotW/Math.max(1,data.length-1))); const y=pad.t+plotH-(v/maxY)*plotH; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke(); }
  line(goals,"#1f7a1f"); line(shots,"#1f4f7a");
}

document.getElementById("pctMode").addEventListener("change",(e)=>{ state.settings.pctMode=!!e.target.checked; save(state); renderCurrent(); renderGames(); renderSeason(); });

function toCSV(){
  const headers = ["date","opponent","notes"].concat(statDefs.map(s=>s.label.replace(/,/g,""))).concat(["Points","ShotPct"]);
  const rows=[headers.join(",")];
  state.games.forEach(g=>{ const goals=g.stats.goal, shots=g.stats.shot, assists=g.stats.assist, points=goals+assists, shotpct=pct(goals,shots,state.settings.pctMode);
    const cols=[g.date,(g.opponent||""),(g.notes||"").replace(/\n/g," ").replace(/,/g,";")].concat(statDefs.map(s=>g.stats[s.key]||0)).concat([points,shotpct]);
    rows.push(cols.join(",")); });
  return rows.join("\n"); }
document.getElementById("csvBtn").addEventListener("click",()=>{ const blob=new Blob([toCSV()],{type:"text/csv;charset=utf-8"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="ryan_wp_stats.csv"; a.click(); URL.revokeObjectURL(url); menu.classList.remove('open'); });
document.getElementById("backupBtn").addEventListener("click",()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="ryan_wp_backup.json"; a.click(); URL.revokeObjectURL(url); menu.classList.remove('open'); });
document.getElementById("importLabel").addEventListener("click",()=>{ document.getElementById("importJSON").click(); menu.classList.remove('open'); });
document.getElementById("importJSON").addEventListener("change",(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(!obj || !Array.isArray(obj.games)) throw new Error("Invalid backup"); state=obj; save(state); alert("Imported."); renderGames(); renderSeason(); drawTrend(); renderCurrent(); }catch(err){ alert("Import failed: "+err.message); } }; r.readAsText(f); });
document.getElementById("resetBtn").addEventListener("click",()=>{ if(!confirm("Erase ALL data on this device?")) return; state={games:[],settings:{pctMode:false}}; save(state); localStorage.removeItem(DRAFT_KEY); current=blankGame(); undoStack=[]; dateEl.value=current.date; oppEl.value=""; notesEl.value=""; renderCurrent(); renderGames(); renderSeason(); drawTrend(); menu.classList.remove('open'); });

renderGames(); renderSeason(); drawTrend();

if ("serviceWorker" in navigator) { window.addEventListener("load", ()=>navigator.serviceWorker.register("sw.js").catch(()=>{})); }
</script>
</body>
</html>
